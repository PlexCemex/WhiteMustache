<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Платформа подработки ДВФУ — Вакансии</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        header {
            background: #003d82;
            color: white;
            padding: 20px 0;
            border-bottom: 3px solid #0066cc;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .logo { font-size: 20px; font-weight: 600; white-space: nowrap; }

        nav {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        nav a { color: white; text-decoration: none; font-size: 15px; }

        .user-info {
            font-size: 13px;
            color: #e0e7f5;
            text-align: right;
            min-width: 180px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-title {
            color: #003d82;
            margin-bottom: 25px;
            font-size: 28px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 4px rgba(0,102,204,0.3);
        }

        button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover { background: #003d82; transform: translateY(-2px); }
        button:active { transform: translateY(0); }

        .vacancies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .vacancy-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .vacancy-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }

        .vacancy-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .vacancy-title {
            color: #003d82;
            font-size: 18px;
            font-weight: 600;
        }

        .vacancy-org {
            color: #0066cc;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .vacancy-salary {
            color: #28a745;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .vacancy-dates {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .vacancy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .tag {
            display: inline-block;
            background: #f0f0f0;
            color: #003d82;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid #ddd;
        }

        .vacancy-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-respond {
            width: 100%;
            background: #0066cc;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-respond:hover { background: #003d82; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            color: #003d82;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #003d82;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            font-size: 13px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .modal-buttons .btn-cancel {
            background: #999;
        }

        .modal-buttons .btn-cancel:hover { background: #777; }

        .notifications-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #28a745;
        }

        .notifications-title {
            color: #003d82;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .notification-item {
            padding: 12px;
            background: #f0f8f0;
            border-left: 3px solid #28a745;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-item:hover {
            background: #e8f5e8;
            transform: translateX(4px);
        }

        .faq-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .faq-btn:hover {
            background: #003d82;
            transform: scale(1.1);
        }

        footer {
            background: #f0f0f0;
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 13px;
            color: #666;
        }

        @media (max-width: 600px) {
            .controls { grid-template-columns: 1fr; }
            .vacancies-grid { grid-template-columns: 1fr; }
            .checkbox-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">Платформа подработки ДВФУ</div>
        <nav>
            <a href="main.html">Главная</a>
            <a href="vacancy.html">Вакансии</a>
            <a href="employer.html">Работодателям</a>
        </nav>
        <div id="userInfo" class="user-info">Не авторизован</div>
    </div>
</header>

<div class="container">
    <h1 class="page-title">Доступные вакансии</h1>

    <div class="controls">
        <input type="number" id="salaryMin" placeholder="Мин. зарплата" min="0">
        <input type="date" id="dateBegin" placeholder="Дата начала">
        <input type="date" id="dateEnd" placeholder="Дата окончания">
        <select id="tagsFilter">
            <option value="">Выберите тег...</option>
        </select>
        <button onclick="applyFilters()">Применить фильтры</button>
    </div>

    <div id="notificationsContainer" style="display:none;">
        <div class="notifications-section">
            <div class="notifications-title">✓ Ваши одобрения</div>
            <div id="notificationsList"></div>
        </div>
    </div>

    <div class="vacancies-grid" id="vacanciesContainer">
        <div style="text-align: center; color: #999; padding: 40px; grid-column: 1/-1;">
            Загрузка вакансий...
        </div>
    </div>
</div>

<!-- Modal отклика -->
<div class="modal" id="respondModal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Отклик на вакансию</span>
            <button class="modal-close" onclick="closeModal('respondModal')">✕</button>
        </div>
        <form onsubmit="submitResponse(event)">
            <div class="form-group">
                <label>Вакансия: <span id="vacancyTitle"></span></label>
            </div>
            <div class="form-group">
                <label>Дата начала:</label>
                <input type="date" id="startDate" required>
            </div>
            <div class="form-group">
                <label>Дата окончания:</label>
                <input type="date" id="endDate" required>
            </div>
            <div class="form-group">
                <label>О себе:</label>
                <textarea id="aboutMe" required placeholder="Расскажите о себе, опыте..."></textarea>
            </div>
            <div class="form-group">
                <label>Выберите компетенции:</label>
                <div class="checkbox-group" id="tagsCheckbox"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="closeModal('respondModal')">Отменить</button>
                <button type="submit" style="background: #0066cc;">Отправить отклик</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal FAQ -->
<div class="modal" id="faqModal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Справка и предложения</span>
            <button class="modal-close" onclick="closeModal('faqModal')">✕</button>
        </div>
        <h3 style="color: #003d82; margin-bottom: 15px;">Часто задаваемые вопросы</h3>
        <p style="margin-bottom: 15px; font-size: 13px; line-height: 1.6;">
            <strong>Q: Как откликнуться на вакансию?</strong><br>
            A: Нажмите кнопку «Откликнуться» на вакансии, заполните дату работы и расскажите о себе.
        </p>
        <p style="margin-bottom: 15px; font-size: 13px; line-height: 1.6;">
            <strong>Q: Что такое компетенции?</strong><br>
            A: Это теги, соответствующие вашим навыкам для конкретной вакансии.
        </p>
        <p style="margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
            <strong>Q: Как узнать о решении?</strong><br>
            A: Вы получите уведомление в разделе «Ваши одобрения».
        </p>

        <form onsubmit="submitSuggestion(event)" style="border-top: 1px solid #ddd; padding-top: 20px;">
            <label style="color: #003d82; font-weight: 600; margin-bottom: 10px; display: block;">
                Ваше предложение или претензия:
            </label>
            <textarea id="suggestion" required
                      placeholder="Опишите вашу идею или проблему..."
                      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; font-family: inherit; min-height: 80px;"></textarea>
            <button type="submit" style="margin-top: 10px; width: 100%; background: #0066cc;">Отправить</button>
        </form>
    </div>
</div>

<button class="faq-btn" onclick="openModal('faqModal')">?</button>

<footer>
    <p>&copy; 2026 Платформа подработки ДВФУ.</p>
</footer>

<script>
    const apiServer = 'http://localhost';

    let currentVacancyId = null;
    let allTags = [];
    let allVacancies = [];
    let currentUser = null;

    function getCurrentUser() {
        const raw = localStorage.getItem('jobPlatformUser');
        if (!raw) return null;
        try { return JSON.parse(raw); } catch (_) { return null; }
    }

    function initUser() {
        currentUser = getCurrentUser();
        const info = document.getElementById('userInfo');

        if (!currentUser) {
            if (info) info.textContent = 'Не авторизован';
            // Никаких редиректов — можно смотреть список, но нельзя откликаться
            return;
        }

        const isEmployer = !!currentUser.organization;
        const isStudent  = !!currentUser.student;

        let roleLabel;
        if (isEmployer && isStudent)      roleLabel = 'Студент и работодатель';
        else if (isEmployer)             roleLabel = 'Работодатель';
        else if (isStudent)              roleLabel = 'Студент';
        else                             roleLabel = 'Пользователь платформы';

        if (info) info.textContent = currentUser.login + ' — ' + roleLabel;
    }

    async function loadVacancies() {
        try {
            const res = await fetch(apiServer + '/JobService/hs/jobservice/vacancylist/');
            allVacancies = await res.json();
            displayVacancies(allVacancies);
            loadNotifications();
        } catch (e) {
            document.getElementById('vacanciesContainer').innerHTML =
                '<div style="grid-column:1/-1; color:red; text-align:center;">Ошибка подключения к серверу</div>';
        }
    }

    async function loadTags() {
        try {
            const res = await fetch(apiServer + '/JobService/hs/jobservice/tags');
            allTags = await res.json();
            populateTagFilter();
        } catch (e) {
            console.error('Ошибка загрузки тегов', e);
        }
    }

    function populateTagFilter() {
        const select = document.getElementById('tagsFilter');
        allTags.forEach(tag => {
            const opt = document.createElement('option');
            opt.value = tag;
            opt.textContent = tag;
            select.appendChild(opt);
        });

        const checkboxContainer = document.getElementById('tagsCheckbox');
        allTags.forEach(tag => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" value="${tag}"> ${tag}`;
            checkboxContainer.appendChild(label);
        });
    }

    function displayVacancies(vacancies) {
        const container = document.getElementById('vacanciesContainer');
        if (!vacancies || vacancies.length === 0) {
            container.innerHTML =
                '<div style="grid-column:1/-1; text-align:center; color:#999; padding:40px;">Вакансий не найдено</div>';
            return;
        }

        container.innerHTML = vacancies.map(v => `
            <div class="vacancy-card">
                <div class="vacancy-header">
                    <div class="vacancy-title">${v.Title}</div>
                </div>
                <div class="vacancy-org">${v.Organization}</div>
                <div class="vacancy-salary">₽ ${Number(v.Salary).toLocaleString('ru-RU')}</div>
                <div class="vacancy-dates">
                    ${formatDate(v.DateOfBegin)} - ${formatDate(v.DateOfEnd)}
                </div>
                <div class="vacancy-tags">
                    ${(v.TypesOfWork || []).map(t => `<span class="tag">${t}</span>`).join('')}
                </div>
                <div class="vacancy-desc">${v.Description}</div>
                <button class="btn-respond" onclick="openRespondModal('${v.Number}', '${v.Title}')">
                    Откликнуться
                </button>
            </div>
        `).join('');
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function applyFilters() {
        let filtered = allVacancies;

        const salary = document.getElementById('salaryMin').value;
        if (salary) {
            filtered = filtered.filter(v => Number(v.Salary) >= parseInt(salary, 10));
        }

        const tag = document.getElementById('tagsFilter').value;
        if (tag) {
            filtered = filtered.filter(v => (v.TypesOfWork || []).includes(tag));
        }

        displayVacancies(filtered);
    }

    function openRespondModal(vacancyId, vacancyTitle) {
        if (!currentUser) {
            alert('Для отклика нужно сначала войти на главной странице.');
            window.location.href = 'main.html';
            return;
        }
        if (!currentUser.student) {
            alert('Отклик на вакансию доступен только студентам.');
            return;
        }

        currentVacancyId = vacancyId;
        document.getElementById('vacancyTitle').textContent = vacancyTitle;
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('aboutMe').value = '';
        document.querySelectorAll('#tagsCheckbox input[type="checkbox"]').forEach(cb => cb.checked = false);
        openModal('respondModal');
    }

    async function submitResponse(e) {
        e.preventDefault();

        if (!currentUser || !currentUser.student) {
            alert('Ошибка: студент не авторизован в системе.');
            return;
        }

        const startDate = document.getElementById('startDate').value.replace(/-/g, '');
        const endDate   = document.getElementById('endDate').value.replace(/-/g, '');
        const description = document.getElementById('aboutMe').value;

        const payload = {
            startperiod: startDate,
            endperiod: endDate,
            student: currentUser.student,   // СНИЛС из checkaccount
            description: description,
            vacancy: currentVacancyId
        };

        try {
            const res = await fetch(apiServer + '/JobService/hs/jobservice/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                alert('Отклик отправлен успешно!');
                closeModal('respondModal');
                loadNotifications();
            } else {
                alert('Ошибка отправки отклика. Код: ' + res.status);
            }
        } catch (e) {
            alert('Ошибка подключения: ' + e.message);
        }
    }

    async function loadNotifications() {
        if (!currentUser || !currentUser.student) return;

        try {
            const res = await fetch(
                apiServer + '/JobService/hs/jobservice/mynotify/?student=' +
                encodeURIComponent(currentUser.student)
            );
            if (!res.ok) return;

            const notifications = await res.json();
            if (notifications && notifications.length > 0) {
                document.getElementById('notificationsContainer').style.display = 'block';
                document.getElementById('notificationsList').innerHTML = notifications.map(n => `
                    <div class="notification-item" onclick="viewVacancyFromNotify('${n.NumberOfRequest}')">
                        <strong>Новое уведомление</strong><br>
                        ${n.Text.substring(0, 100)}...
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error('Ошибка загрузки уведомлений', e);
        }
    }

    async function viewVacancyFromNotify(requestNumber) {
        try {
            const res = await fetch(
                apiServer + '/JobService/hs/jobservice/vacancyfromnotify/?numberofrequest=' + requestNumber
            );
            if (!res.ok) {
                alert('Ошибка загрузки вакансии');
                return;
            }
            const vacancy = await res.json();
            if (vacancy && vacancy.length > 0) {
                const v = vacancy[0];
                alert(
                    v.Organization + '\n' +
                    v.Title + '\n' +
                    '₽' + v.Salary + '\n\n' +
                    v.Description
                );
            }
        } catch (e) {
            alert('Ошибка загрузки вакансии');
        }
    }

    async function submitSuggestion(e) {
        e.preventDefault();
        const text = document.getElementById('suggestion').value;

        try {
            const res = await fetch(apiServer + '/JobService/hs/jobservice/faq', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ suggestion: text })
            });
            if (res.ok) {
                alert('Спасибо за ваше предложение!');
                document.getElementById('suggestion').value = '';
                closeModal('faqModal');
            } else {
                alert('Ошибка отправки. Код: ' + res.status);
            }
        } catch (e) {
            alert('Ошибка подключения');
        }
    }

    function openModal(id)   { document.getElementById(id).classList.add('active'); }
    function closeModal(id)  { document.getElementById(id).classList.remove('active'); }

    // Инициализация
    initUser();
    loadTags();
    loadVacancies();
    setInterval(loadNotifications, 30000);
</script>
</body>
</html>
